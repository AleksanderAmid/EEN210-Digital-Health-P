<html>
  <head>
    <title>Fall Detection</title>
    <style>
      /* Container to hold both messages and FHIR data side-by-side */
      #container {
        display: flex;
        flex-wrap: wrap;
      }
      /* Style for the message log area */
      #messages {
        overflow-y: scroll;
        height: 90vh;
        width: 45vw;
        list-style-type: none;
        padding: 0;
        margin: 10px;
      }
      /* Styling for FHIR data sections */
      #fhirData {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #000;
        width: 45vw;
        margin: 10px;
      }
      #fhirData h2,
      #fhirData h3 {
        margin: 10px 0;
      }
      #fhirData ul {
        list-style-type: none;
        padding: 0;
      }
      /* Ensure long words break */
      li {
        word-wrap: break-word;
      }
      /* Style for simulation button */
      #simulateData {
        margin: 10px;
        padding: 8px 16px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h1>Real-time Data Collection</h1>
    <button id="closeButton">Close Connection</button>
    <!-- Button to simulate data -->
    <button id="simulateData">Simulate Data</button>

    <div id="container">
      <ul id="messages"></ul>

      <!-- Section for FHIR Data -->
      <div id="fhirData">
        <h2>FHIR Data</h2>
        <div id="patientInfo">
          <h3>Patient Information</h3>
          <ul id="patientDetails"></ul>
        </div>
        <!-- Conditions list now with dashes -->
        <div id="conditionInfo">
          <h3>Conditions</h3>
          <ul id="conditionsDetails"></ul>
        </div>
        <!-- Medications list now with dashes -->
        <div id="medicationInfo">
          <h3>Medications</h3>
          <ul id="medicationsDetails"></ul>
        </div>
      </div>
    </div>

    <script>
      // Global variables to store the current patient's ID and Name (for display purposes)
      var currentPatientId = "N/A";
      var currentPatientName = "N/A";

      // Change the IP address based on your current wifi/ip address
      var ipAddress = "your_IP_Address";
      var ws = new WebSocket("ws://" + ipAddress + ":8000/ws");

      // Utility: calculate age from birth date
      function calculateAge(birthDateString) {
        var birthDate = new Date(birthDateString);
        var diff = Date.now() - birthDate.getTime();
        var ageDt = new Date(diff);
        return Math.abs(ageDt.getUTCFullYear() - 1970);
      }

      // Update FHIR display panels with patient data
      function fetchFallRelatedData(patient) {
        // Store current patient id globally for FHIR display panels only
        currentPatientId = patient.id || "N/A";

        // Display patient info (including heart rate, BMI and patient ID)
        var patientDetails = document.getElementById('patientDetails');
        patientDetails.innerHTML = "";
        let name = "N/A";
        if (patient.name && patient.name.length > 0) {
          const pName = patient.name[0];
          name = (pName.given ? pName.given.join(" ") : "") + " " + (pName.family || "");
        }
        currentPatientName = name; // Store the patient name globally

        var age = patient.birthDate ? calculateAge(patient.birthDate) : "N/A";
        patientDetails.innerHTML += "<li><strong>Name:</strong> " + name + "</li>";
        patientDetails.innerHTML += "<li><strong>Patient ID:</strong> " + currentPatientId + "</li>";
        patientDetails.innerHTML += "<li><strong>Gender:</strong> " + (patient.gender || "N/A") + "</li>";
        patientDetails.innerHTML += "<li><strong>Birth Date:</strong> " + (patient.birthDate || "N/A") + " (Age: " + age + ")</li>";

        // Fetch Heart Rate observation (LOINC code 8867-4) and append into patientDetails
        fetch('https://fhirsandbox.healthit.gov/open/r4/fhir/Observation?patient=' + patient.id + '&code=8867-4&_format=json')
          .then(response => response.json())
          .then(data => {
            if (data.entry && data.entry.length > 0) {
              var hrObs = data.entry[0].resource;
              let hrValue = "No value provided";
              if (hrObs.valueQuantity) {
                hrValue = hrObs.valueQuantity.value + " " + (hrObs.valueQuantity.unit || "bpm");
              } else if (hrObs.valueString) {
                hrValue = hrObs.valueString;
              }
              let codeText = (hrObs.code && hrObs.code.text) ? hrObs.code.text : "Heart Rate";
              patientDetails.innerHTML += "<li><strong>" + codeText + ":</strong> " + hrValue + "</li>";
            } else {
              patientDetails.innerHTML += "<li>No heart rate data available</li>";
            }
          })
          .catch(error => console.error("Error fetching heart rate data:", error));

        // Fetch BMI (LOINC code 39156-5) and append into patientDetails
        fetch('https://fhirsandbox.healthit.gov/open/r4/fhir/Observation?patient=' + patient.id + '&code=39156-5&_format=json')
          .then(response => response.json())
          .then(data => {
            if (data.entry && data.entry.length > 0) {
              var bmiObs = data.entry[0].resource;
              let bmiValue = "No value provided";
              if (bmiObs.valueQuantity) {
                bmiValue = bmiObs.valueQuantity.value + " " + (bmiObs.valueQuantity.unit || "");
              }
              patientDetails.innerHTML += "<li><strong>BMI:</strong> " + bmiValue + "</li>";
            } else {
              patientDetails.innerHTML += "<li>No BMI data available</li>";
            }
          })
          .catch(error => console.error("Error fetching BMI data:", error));

        // Fetch Conditions (global endpoint filtered for this patient)
        fetch('https://fhirsandbox.healthit.gov/open/r4/fhir/Condition?_format=json')
          .then(response => response.json())
          .then(data => {
            const conditionsDetails = document.getElementById('conditionsDetails');
            conditionsDetails.innerHTML = "";
            let found = false;
            if (data.entry && data.entry.length > 0) {
              data.entry.forEach(entry => {
                const condition = entry.resource;
                if (
                  condition.subject &&
                  condition.subject.reference &&
                  patient.id &&
                  condition.subject.reference === ("Patient/" + patient.id)
                ) {
                  found = true;
                  let conditionText =
                    condition.code &&
                    condition.code.coding &&
                    condition.code.coding.length > 0 &&
                    condition.code.coding[0].display
                      ? condition.code.coding[0].display
                      : "Unnamed Condition";
                  conditionsDetails.innerHTML += "<li>- " + conditionText + "</li>";
                }
              });
            }
            if (!found) {
              conditionsDetails.innerHTML += "<li>- No conditions available</li>";
            }
          })
          .catch(error => console.error("Error fetching conditions:", error));

        // Fetch Medications using the MedicationRequest endpoint (patient-specific)
        fetch('https://fhirsandbox.healthit.gov/open/r4/fhir/MedicationRequest?patient=' + patient.id + '&_format=json')
          .then(response => response.json())
          .then(data => {
            const medicationsDetails = document.getElementById('medicationsDetails');
            medicationsDetails.innerHTML = "";
            let foundMeds = false;
            if (data.entry && data.entry.length > 0) {
              let medsDisplayed = [];
              data.entry.forEach(entry => {
                const medRequest = entry.resource;
                if (!medRequest.status || medRequest.status === "active") {
                  let medText =
                    medRequest.medicationCodeableConcept &&
                    medRequest.medicationCodeableConcept.text
                      ? medRequest.medicationCodeableConcept.text
                      : "Medication info not available";
                  if (medsDisplayed.indexOf(medText) === -1) {
                    medsDisplayed.push(medText);
                    medicationsDetails.innerHTML += "<li>- " + medText + "</li>";
                    foundMeds = true;
                  }
                }
              });
            }
            if (!foundMeds) {
              medicationsDetails.innerHTML += "<li>- No active medication data available</li>";
            }
          })
          .catch(error => console.error("Error fetching medications:", error));
      }

      // Modify fetchPatientAndFallData to return a promise that resolves with the fetched patient.
      function fetchPatientAndFallData() {
        return fetch('https://fhirsandbox.healthit.gov/open/r4/fhir/Patient?_format=json')
          .then(response => response.json())
          .then(data => {
            if (data.entry && data.entry.length > 0) {
              const randomIndex = Math.floor(Math.random() * data.entry.length);
              const patient = data.entry[randomIndex].resource;
              // Call fetchFallRelatedData to update the FHIR panels.
              fetchFallRelatedData(patient);
              return patient;
            } else {
              return null;
            }
          })
          .catch(error => {
            console.error("Error fetching patient data:", error);
            return null;
          });
      }

      // WebSocket handling
      ws.onopen = function(event) {
        console.log("WebSocket state:", ws.readyState);
      };

      ws.onmessage = function(event) {
        console.log("Received data:", event.data);
        var messages = document.getElementById('messages');
        try {
          var json_data = JSON.parse(event.data);
          // Determine label based on fallDetected flag
          var label = json_data.fallDetected ? 1 : 0;
          var labelText = label === 1 ? "fall detected" : "no fall detected";
          // Get timestamp of data point reception.
          var timestamp = new Date().toLocaleString();

          // If a fall is detected, fetch patient data to get the name; otherwise use "N/A"
          if (json_data.fallDetected) {
            fetchPatientAndFallData().then(function(patient) {
              var pname = patient ? currentPatientName : "N/A";
              var message = document.createElement('li');
              message.textContent = "Patient: " + pname + " | Timestamp: " + timestamp + " | Label: " + labelText;
              messages.appendChild(message);
              messages.scrollTop = messages.scrollHeight;
            });
          } else {
            var message = document.createElement('li');
            message.textContent = "Patient: N/A | Timestamp: " + timestamp + " | Label: " + labelText;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
          }
        } catch (e) {
          console.error("Error parsing JSON data:", e);
        }
      };

      ws.onclose = function(event) {
        console.log("WebSocket closed:", event);
      };

      // Close connection button
      var closeButton = document.getElementById('closeButton');
      closeButton.addEventListener('click', function() {
        ws.close();
        console.log("Connection Closed");
      });

      // Simulate sensor data (which triggers fallDetected)
      document.getElementById('simulateData').addEventListener('click', function() {
        var sampleData = {
          acceleration_x: (Math.random() * 2 - 1).toFixed(2),
          acceleration_y: (Math.random() * 2 - 1).toFixed(2),
          acceleration_z: (Math.random() * 2 - 1).toFixed(2),
          gyroscope_x: (Math.random() * 2 - 1).toFixed(2),
          gyroscope_y: (Math.random() * 2 - 1).toFixed(2),
          gyroscope_z: (Math.random() < 0.5) ? (Math.random() * 2 - 1).toFixed(2) : "N/A",
          fallDetected: Math.random() < 0.5  // random true/false for simulation
        };

        var messages = document.getElementById('messages');
        var timestamp = new Date().toLocaleString();
        if (sampleData.fallDetected) {
          fetchPatientAndFallData().then(function(patient) {
            var pname = patient ? currentPatientName : "N/A";
            var message = document.createElement('li');
            message.textContent = "Patient: " + pname + " | Timestamp: " + timestamp + " | Label: fall detected";
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
          });
        } else {
          var message = document.createElement('li');
          message.textContent = "Patient: N/A | Timestamp: " + timestamp + " | Label: no fall detected";
          messages.appendChild(message);
          messages.scrollTop = messages.scrollHeight;
        }
      });
    </script>
  </body>
</html>